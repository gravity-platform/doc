---
title: MongoDB Migrations
layout: default
top_nav: guides
---

# MongoDB Migrations

This guide describes how to create and run mongodb migrations.

## Introduction

From time to time there are structural or other changes to the data in the MongoDB persitance layer. When
we make changes to the structure of said data we need a way to ensure that all our entities get updated
after changes.

While [doctrine odm](http://docs.doctrine-project.org/projects/doctrine-mongodb-odm/en/latest/) suggests that
[we do it manually](http://doctrine-orm.readthedocs.org/projects/doctrine-mongodb-odm/en/latest/reference/migrating-schemas.html)
by implementing migration code on the document level, this won't cut it for us since most of our document classes have been
generated by graviton. For this reason we support [mongodb-migrations](https://github.com/antimattr/mongodb-migrations) that are
similar to regular [doctrine orm migrations](http://doctrine-orm.readthedocs.org/projects/doctrine-migrations/en/latest/reference/introduction.html).

## Preparing Bundles for Migrations

Each graviton bundle that contains migrations needs to be prepared in a specific way. It needs a location migrations configuration and the path to
the migrations directort needs to be added to the autloader.

For the purpose of this documentation we are assuming that a bundle has the following structure.

```
.
|____composer.json
|____src
| |____Migrations
| | |____MongoDB
| |____Resources
| | | |____Version20151119140145.php
| | |____config
| | | |____migrations.yml
| | |____definition
| | | |____DocumentDefinition.json
```

The file `migrations.yml` configures the bundle level migration support.

```
# migrations.yml
---
name: acme-bundle migrations
collection_name: acme-bundle-migrations
migrations_namespace: AcmeBundle\Migrations\MongoDB
migrations_directory: vendor/grv/acme-bundle/src/Migrations/MongoDB
```

The namespaces of the migration classes is registered in `composer.json`.

```
# composer.json
{
    "autoload": {
        "psr-4": {"AcmeBundle\\": "src/"}
    }
}
```

With this the migration code knows where to find migration code as well as where to store
metadata pertaining to the migrations.

## Generating and Writing Migrations

## Running Migrations

